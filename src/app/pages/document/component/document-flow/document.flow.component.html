<toast-messages/>
<div class="flex flex-col">
    <div class="flex flex-grow flex-col justify-between gap-8 min-h-[calc(100vh-8rem)]">
        <div class="flex flex-col gap-5">
            <div class="bg-[var(--surface-card)] rounded-[var(--content-border-radius)] shadow-md p-0">
                <p-panel header="Flow Steps" class="border-none" [toggleable]="true" [collapsed]="false">
                    <p-stepper [value]="flowDoc?.activeStep">
                        <p-step-list style="align-items: flex-start">
                            <p-step *ngFor="let group of groupedSteps; let i = index"
                                    [value]="group.stepno"
                                    style="align-items: flex-start"
                                    class="flex flex-row flex-auto gap-2 min-h-[13.5dvh]">
                                <ng-template #content let-value="value">
                                    <div class="flex flex-col gap-2 items-center">
                                        <div class="flex flex-col gap-2 items-center min-h-[5dvh]">
                                            <span class="rounded-full relative w-[24px] h-[24px] inline-flex items-center justify-center border-2 transition-colors transition-duration-300"
                                                  [ngClass]="{
                                              'border-primary': group.stepno <= flowDoc?.activeStep,
                                              'border-300 bg-highlight text-500': group.stepno > flowDoc?.activeStep
                                          }">
                                        <i [class]="resolveStepIcon(group.actions[0])" style="font-size: 0.8rem"></i>
                                    </span>
                                            <span *ngIf="group.actions[0].actionDate" class="text-[9px] text-[var(--text-color)] opacity-60">
                                             {{ group.actions[0].actionDate | date:appProperties.dateTimeFormat }}
                                        </span>
                                        </div>
                                        <div class="flex flex-col gap-2 items-center">
                                            <ng-container *ngFor="let action of group.actions; let actionIndex = index">
                                                <div class="flex items-center gap-3 bg-[var(--surface-overlay)]
                                                     border border-[var(--surface-border)] p-3
                                                     rounded-[var(--content-border-radius)]
                                                     {{(actionIndex === 0 || expandedSteps.has(i)) ? '' : 'hidden'}}
                                                     shadow-sm min-w-[170px]">
                                                    <div class="relative w-10 h-10 shrink-0">
                                                        <img [src]="action.imageUrl || 'assets/defaultAvatar.png'" alt="avatar" class="w-10 h-10 rounded-full object-cover shrink-0"/>
                                                    </div>
                                                    <div class="flex flex-col gap-1 overflow-hidden items-start text-left">
                                                        <div class="flex flex-col">
                                                            <span class="text-[10px] text-[var(--text-color)] opacity-70 truncate font-bold">
                                                                {{ action.actionType }}
                                                            </span>
                                                        </div>
                                                        <span class="text-sm font-bold text-[var(--text-color)] truncate">
                                                            {{ action.emmanInfo.name }}
                                                        </span>
                                                    </div>
                                                </div>
                                            </ng-container>
                                            <button *ngIf="group.actions.length > 1"
                                                    type="button"
                                                    style="font-size: 0.75rem"
                                                    class="w-fit rounded-full p-button p-buttongroup p-button-text p-button-secondary mt-2 gap-2"
                                                    (click)="toggleStep(i)">
                                                <span class="{{expandedSteps.has(group.stepno) ? 'pi pi-chevron-up' : 'pi pi-chevron-down'}}"></span>
                                                <span>{{ expandedSteps.has(group.stepno) ? 'Show Less' : 'Show More' }}</span>
                                            </button>
                                        </div>
                                    </div>
                                </ng-template>
                            </p-step>
                        </p-step-list>
                    </p-stepper>
                </p-panel>
            </div>

            <div class="bg-[var(--surface-card)] rounded-[var(--content-border-radius)] shadow-md p-0">
                <p-panel header="Document Information" [toggleable]="true" [collapsed]="false">
                    <div class="ml-7 grid grid-cols-[150px_1fr] gap-x-4 gap-y-4 p-2 max-h-[20dvh] overflow-y-auto">
                        <ng-container *ngFor="let dataFld of flowContentKeys">
                            <ng-container *ngIf="flowContent[dataFld]">
                                <ng-container [ngSwitch]="flowContentDataType.get(dataFld)">

                                    <ng-container *ngSwitchCase="'OBJECT'">
                                        <!--Not Show Data-->
                                    </ng-container>

                                    <ng-container *ngSwitchCase="'DATE'">
                                        <span class="text-sm text-secondary">{{ fieldLabels[dataFld] || dataFld }}</span>
                                        <span class="font-medium text-sm">
                                        {{ (flowContent[dataFld] && flowContent[dataFld] !== '') ? (flowContent[dataFld] | date:appProperties.dateFormat) : '' }}
                                    </span>
                                    </ng-container>

                                    <ng-container *ngSwitchCase="'BOOLEAN'">
                                        <span class="text-sm text-secondary">{{ fieldLabels[dataFld] || dataFld }}</span>
                                        <span class="font-medium text-sm">{{ flowContent[dataFld] | yesNo }}</span>
                                    </ng-container>

                                    <ng-container *ngSwitchCase="'DECIMAL'">
                                        <span class="text-sm text-secondary">{{ fieldLabels[dataFld] || dataFld }}</span>
                                        <span class="font-medium text-sm">{{ flowContent[dataFld] | number:'1.2-2' }}</span>
                                    </ng-container>

                                    <ng-container *ngSwitchCase="'LIST'">
                                    <span class="text-sm text-secondary" *ngIf="flowContent[dataFld].length > 0">
                                        {{ fieldLabels[dataFld] || dataFld }}
                                    </span>

                                        <div *ngIf="flowContent[dataFld].length > 0" class="flex flex-col gap-2">
                                            <div *ngFor="let file of flowContent[dataFld]" class="w-64 flex items-center justify-between p-2 bg-gray-50 rounded-lg border border-gray-100 hover:bg-gray-100 transition-colors">

                                                <div class="flex items-center gap-2 overflow-hidden flex-1 mr-2"
                                                     [pTooltip]="file.fileName"
                                                     tooltipPosition="top">
                                                    <i class="pi pi-file text-primary shrink-0"></i>
                                                    <span class="text-sm truncate font-medium text-gray-700">
                                                    {{ file.fileName }}
                                                </span>
                                                </div>

                                                <p-button icon="pi pi-download"
                                                          [rounded]="true"
                                                          [text]="true"
                                                          severity="primary"
                                                          size="small"
                                                          (onClick)="downloadFile(file)"
                                                          class="shrink-0">
                                                </p-button>
                                            </div>
                                        </div>
                                    </ng-container>

                                    <ng-container *ngSwitchDefault>
                                        <span class="text-sm text-secondary">{{ fieldLabels[dataFld] || dataFld }}</span>
                                        <span class="font-medium text-sm">{{ flowContent[dataFld] }}</span>
                                    </ng-container>

                                </ng-container>
                            </ng-container>
                        </ng-container>
                    </div>
                </p-panel>
            </div>
        </div>
        <div class="flex justify-between gap-2 bg-[var(--surface-card)] rounded-[var(--content-border-radius)] shadow-md p-3">
            <div class="flex flex-row gap-2">
                <p-button label="Submit" *ngIf="stepActive?.actionType === 'REQUEST'" (onClick)="ngSubmit()" [loading]="loading" [disabled]="!isActiveStep" ></p-button>
                <p-button label="Approve" severity="success" *ngIf="stepActive?.actionType === 'WAITING'"  [loading]="loading" [disabled]="!isActiveStep" ></p-button>
                <p-button label="Back" (onClick)="pageBack()" [loading]="loading" [outlined]="true"></p-button>
            </div>
            <div>
                <p-button label="Cancel" severity="danger" *ngIf="stepActive?.actionType === 'WAITING'"  [loading]="loading" [disabled]="!isActiveStep" ></p-button>
            </div>
        </div>
    </div>

</div>